Bootstrap: docker
From: ubuntu:22.04

%labels
    Author OpenMPI Builder
    Version 4.1.5

%environment
    export PATH=/opt/openmpi-4.1.5/bin:$PATH
    export LD_LIBRARY_PATH=/opt/openmpi-4.1.5/lib:$LD_LIBRARY_PATH

%post
    apt-get update && apt-get install -y \
        build-essential \
        g++ \
        gfortran \
        libevent-dev \
        libhwloc-dev \
        libpmix-dev \
        libslurm-dev \
        wget \
        git

    # Download and build OpenMPI
    cd /opt
    wget https://download.open-mpi.org/release/open-mpi/v4.1/openmpi-4.1.5.tar.gz
    tar -xzf openmpi-4.1.5.tar.gz
    cd openmpi-4.1.5

    ./configure --prefix=/opt/openmpi-4.1.5 \
        --with-pmix=/usr/lib/x86_64-linux-gnu/pmix2 \
        --with-slurm \
        --enable-mpirun-prefix-by-default \
        --enable-mpi-cxx

    make -j$(nproc)
    make install

%runscript
    echo "OpenMPI 4.1.5 container is ready."
